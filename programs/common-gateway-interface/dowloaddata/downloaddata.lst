     1                                  ; Name:     downloaddata.asm
     2                                  ; Build:    see makefile
     3                                  ; Description:
     4                                  ; Demonstration of a simple downloadable file, the contents of the file are in the program.
     5                                  ; (It could be the binary of this program too.)
     6                                  ; If you should see errors instead of a download window check if fastcgi is enabled on your apache server.
     7                                  ; appearantle mod-cgi alone isn't enough to serve this program
     8                                  ; sudo apt-get install libapache2-mod-fastcgi
     9                                  ; sudo a2enmod fastcgi
    10                                  ; sudo service apache2 restart
    11                                  
    12                                  bits 64
    13                                  
   330                                  [list -]
   331                                  
   332                                  section .bss
   333                                  
   334                                  section .data
   335                                  
   336                                  httpheader:
   337 00000000 436F6E74656E742D74-          db   'Content-type: application/octet-stream', 10
   338 00000009 7970653A206170706C-
   339 00000012 69636174696F6E2F6F-
   340 0000001B 637465742D73747265-
   341 00000024 616D0A             
   342 00000027 436F6E74656E742D44-          db   'Content-Disposition: attachment; filename="data.bin"', 10, 10
   343 00000030 6973706F736974696F-
   344 00000039 6E3A20617474616368-
   345 00000042 6D656E743B2066696C-
   346 0000004B 656E616D653D226461-
   347 00000054 74612E62696E220A0A 
   348                                  .length: equ $-httpheader
   349                                  
   350                                  section .text
   351                                      global _start
   352                                      
   353                                  _start:
   354                                  
   355                                       ; we send the reply in two pieces, to download the binary of this program
   356                                       ; This doesn't send the entire program, only the assembled code of the .text section.
   357                                  data:
   358                                  
   359 00000000 B801000000                   mov       rax, SYS_WRITE
   360 00000005 48BE-                        mov       rsi, httpheader
   361 00000007 [0000000000000000] 
   362 0000000F BA5D000000                   mov       rdx, httpheader.length
   363 00000014 BF01000000                   mov       rdi, STDOUT
   364 00000019 0F05                         syscall
   365                                       
   366 0000001B B801000000                   mov       rax, SYS_WRITE
   367 00000020 48BE-                        mov       rsi, data
   368 00000022 [0000000000000000] 
   369 0000002A BA40000000                   mov       rdx, data.length
   370 0000002F BF01000000                   mov       rdi, STDOUT
   371 00000034 0F05                         syscall
   372                                       
   373 00000036 4831FF                       xor       rdi, rdi
   374 00000039 B83C000000                   mov       rax, SYS_EXIT
   375 0000003E 0F05                         syscall
   376                                       
   377                                  .length: equ $-data     
